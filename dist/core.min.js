!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.CampaignCollector=t():e.CampaignCollector=t()}(this,(()=>(()=>{"use strict";var e={d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>s});class s{#e="CampaignCollector";#t="1.0.0";#s;#n=null;#i={consent:{ad_personalization:null,ad_storage:null,ad_user_data:null,analytics_storage:null},debug:!1,decorateHostnames:[],enableSpaSupport:!1,fieldMap:{anonymous_id:"$ns_anonymous_id",attribution:"$ns_attribution_json",consent:"$ns_consent_json",first:{utm:null,$ns:null},last:{utm:null,$ns:null},cookies:{},globals:{}},fieldTargetMethod:["name"],fieldDataAttribute:"data-campaign-collector",filters:{},firstPartyLeadEndpoint:null,firstPartyCookieEndpoint:null,namespace:"lvl",nullValue:"-",parseRules:{organic:{google:"^www.(google).[a-z]{2,3}(?:.[a-z]{2})?$",bing:"^www.(bing).com$",duckduckgo:"^(duckduckgo).com$",yahoo:"^(?:www|m)?.?(yahoo).(?:com|cn)$",ecosia:"^www.(ecosia).org$",ask:"^www.(ask).com$",aol:"^(?:search.)?(aol).com$",baidu:"^www.(baidu).com$",xfinity:"^my|search.(xfinity).com",yandex:"^(?:www.)?(yandex).com|ru$",lycos:"^(?:www|search)?.?(lycos).[a-z]{2,3}(?:.[a-z]{2})?$"},social:{facebook:"^www.(facebook).com$",instagram:"(instagram).com$",linkedin:"^www.(linkedin).com$",tiktok:"^www.(tiktok).com$",snapchat:"^www.(snapchat).com$",x:"^t.co|x.com$",pinterest:"^www.(pinterest).com$",reddit:"^www.(reddit).com$",quora:"^www.(quora).com$"}},sdk:null,sessionTimeout:null,storageDomain:null,storageMethod:"cookie",storageNamespace:"cc",storeAsBase64:!0,stripUtmsFromInternalLinks:!1,userDataHash:{city:!1,region:!1,postal_code:!1,country:!1}};#o=null;#a={utm:["source","medium","campaign","term","content","id","source_platform","marketing_tactic","creative_format","group","ad","product","feed","creative","extension","geo_int","geo_phy","target","network","device","matchtype","placement"],hsa:["cam","grp","ad","kw","tgt","net","mt","src"],$ns:["platform","source","campaign_name","campaign","group","ad","product","feed","creative","extension","geo_int","geo_phy","target","network","device","matchtype","placement"]};#r={utm:["source","medium","campaign"],$ns:["platform","campaign","group","ad"]};#c=null;#l=null;#h={first:{expires:[400,"days"]},last:{expires:[30,"minutes"]}};#u;constructor(e={}){s.canRun()&&(console.time(this.#e),this.#u=new URL(window.location.href),this.#n=this.#d(this.#i,e),this.#m(),this.#f(),this.#p(),this.#g(),this.#y(),this.#w(),this.#b(["utm",this.#n.namespace]),Array.isArray(this.#n.sessionTimeout)&&(this.#h.last.expires=this.#n.sessionTimeout),this.#l=this.#_(),this.#$(),this.fill(),this.#k(),this.#S("ready",{config:this.#n}),this.#n.debug&&console.log(this.#n),console.timeEnd(this.#e))}static canRun(){return"undefined"!=typeof WeakMap&&"undefined"!=typeof URL&&"undefined"!=typeof localStorage}static create(e={},t=null){if(!s.canRun())return;const n=new s(e);return window._campaignCollector=window._campaignCollector||{},t&&!window._campaignCollector.hasOwnProperty(t)&&(window._campaignCollector[t]=n),["fill","grab","lead","debug"].reduce(((e,t)=>(e[t]=n[t].bind(n),e)),{})}static consentChange(e,t){if(!["ad_storage","ad_user_data","analytics_storage","ad_personalization"].includes(e))throw new Error("Invalid consent key.");if(!["granted","denied",null].includes(t))throw new Error('Invalid consent value. Must be "granted", "denied", or null.');const s="campaign-collector";document.dispatchEvent(new CustomEvent(`${s}:consent.change`,{detail:{type:e,status:t},bubbles:!0})),document.dispatchEvent(new Event(`${s}:${e}.${t}`,{bubbles:!0}))}get activeSession(){const e=this.#l.last;if(!e)return null;const t=Math.ceil(Date.now()/1e3);if(e._exp<t)return null;if(e._ref){const t=this.#O(e._ref);return t?{...e,[this.#n.namespace]:t[this.#n.namespace],utm:t.utm}:e}return e}get allowedFields(){return this.#a}get anonymousId(){return this.#v("analytics_storage")?this.#s:"(redacted)"}#S(e,t={}){dataLayer=window.dataLayer||[];const s={event:`${this.#E(this.#e)}:${e}`,_cc:t};dataLayer.push(s)}debug(){console.log(this.#n)}fill(e={}){e.hasOwnProperty("targetMethod")&&(e.targetMethod=Array.isArray(e.targetMethod)?e.targetMethod:[e.targetMethod]);const t={targetMethod:e.targetMethod||this.#n.fieldTargetMethod,scope:e.scope||document},s=this.#j(this.#n.fieldMap),n=this.grab({without:["params"],dereference:!0});this.#S("fill",{data:n}),["first","last"].forEach((e=>{s[e]&&(s[e]=this.#x(s[e])),n[e]&&(n[e]=this.#x(n[e]))}));for(const[e,i]of Object.entries(s))if("string"!=typeof i)for(const[s,o]of Object.entries(i)){const i=t.scope.querySelectorAll(this.#A(t.targetMethod,o));if(!i?.length)continue;let a=["cookies","globals"].includes(e)?"":this.#n.nullValue,r=n[e][s]??a;["cookies","globals"].includes(e)&&r&&(r=this.#M(this.#n.filters[s],r)),Array.from(i).forEach((e=>{e.value||(e.value=r,e.setAttribute("value",r),e.dispatchEvent(new Event("input",{bubbles:!0})))}))}else{let s=i.replace("$ns",this.#n.storageNamespace);const n=t.scope.querySelectorAll(this.#A(t.targetMethod,s));if(n){const t={anonymous_id:this.anonymousId,consent:JSON.stringify(this.#n.consent),attribution:this.grab({asJson:!0,dereference:!0,without:["params"]})};Array.from(n).forEach((s=>{s.value=t[e],s.setAttribute("value",t[e]),s.dispatchEvent(new Event("input",{bubbles:!0}))}))}}}grab({applyFilters:e=!1,asJson:t=!1,dereference:s=!1,without:n=[]}={}){const i={namespace:this.#n.namespace};return n.includes("anonymous_id")||(i.anonymous_id=this.anonymousId),n.includes("params")||(i.params=this.#o),n.includes("first")||(i.first=this.#l.first),n.includes("last")||(i.last=this.#l.last,s&&this.#l.last._ref&&(i.last=Object.assign(this.#l[this.#l.last._ref],i.last))),n.includes("globals")||(i.globals=this.#L({applyFilters:e})),n.includes("cookies")||(i.cookies=this.#v("ad_user_data")?this.#C({applyFilters:e}):{}),t?JSON.stringify(i):i}async#P(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s)).map((e=>e.toString(16).padStart(2,"0"))).join("")}lead(e={},t={}){if(!this.#n.firstPartyLeadEndpoint)throw new Error("`firstPartyLeadEndpoint` is required to send lead payload.");let s={anonymous_id:this.anonymousId,sent_at:(new Date).getTime(),event:"lead",consent:this.#n.consent,context:{attribution:this.grab({without:["anonymous_id","params","globals"]}),locale:navigator.language,page:{title:document.title,url:location.href,referrer:document.referrer},screen:{width:screen.width,height:screen.height,inner_width:innerWidth,inner_height:innerHeight},sdk:`${this.#e}@${this.#t}`,user_agent:navigator.userAgent}};this.#n.sdk&&(s.context.sdk+=`/${this.#n.sdk}`),Object.keys(e).forEach((t=>{/^[a-z_]+$/.test(t)||(console.warn(`${this.#e}.js: Removing "${t}" from lead payload. Keys must be in snake_case format.`),delete e[t])})),Object.keys(e).length>0&&(s.properties=e),["first_name","last_name","email","phone","city","region","postal_code","country","date_of_birth","gender"].forEach((e=>{t[e]&&(s.hasOwnProperty("user")||(s.user={}),s.user[e]=t[e].trim().toLowerCase(),delete t[e])})),this.#D(`https://${this.#n.firstPartyLeadEndpoint}`,s)}async#D(e,t){try{if(t.user){const e=[...Object.keys(this.#n.userDataHash).filter((e=>this.#n.userDataHash[e])),"first_name","last_name","email","phone","date_of_birth","gender"],s={},n={first_name:e=>e.replace(/[^a-z]/g,""),last_name:e=>e.replace(/[^a-z]/g,""),email:e=>{let[t,n]=e.split("@");s.email_domain=n;let i=[e];return["gmail.com","googlemail.com"].includes(n)&&(t=t.replace(/\./g,""),t=t.split("+")[0],i.push(t+"@"+n)),i},phone:e=>{if((e=e.replace(/[^0-9]/g,"")).length<10||e.length>11)return null;if("1"!==e[0]&&11===e.length)return null;const t=[e=10===e.length?`1${e}`:`${e}`,`+${e}`];return s.phone_area_code=e.substring(1,4),t},city:e=>e.replace(/[^a-z]/g,""),postal_code:e=>e.replace(/[^0-9]/g,"").substring(0,5),date_of_birth:e=>{const t=new Date(e);return s.age=`${Math.floor((new Date-t)/315576e5)}`,t.toISOString().split("T")[0].replace("-","")},gender:e=>e.substring(0,1)},i=(await Promise.all(Object.entries(t.user).map((async([t,s])=>{if(!s)return null;let i=n[t]?n[t](s):s;if(!i)return null;if(Array.isArray(i)){const s=await Promise.all(i.map((async s=>e.includes(t)?await this.#P(s):s)));return s.some((e=>e))?[t,s]:null}{const s=e.includes(t)?await this.#P(i):i;return s?[t,s]:null}})))).filter((e=>null!==e));i.length>0?t.user=Object.assign(Object.fromEntries(i),s):t.user={}}this.#n.debug&&console.log("Sending payload:",t);const s=await fetch(e,{method:"POST",body:btoa(JSON.stringify(t)),keepalive:!0});if(!s.ok)throw new Error(`#send(). Status ${s.status}`)}catch(s){window.Sentry&&(Sentry.setContext("payload",{body:t,endpoint:e}),Sentry.captureException(s));const n=new Error(`#send(): ${s.message}`);setTimeout((()=>{throw n}),0)}}#M(e,t){if("function"!=typeof e)return t;try{t=e(t)}catch(e){console.error(`${this.#e}.js: Error applying filter.`,e.message)}return t}#k(){if(this.#n.enableSpaSupport){this.#I();const e=e=>{this.#y(!0),this.#$()};window.addEventListener("popstate",e),window.onpopstate=history.onpushstate=e}document.addEventListener("click",(e=>{const t=e.target.closest("a[href]");if(!t)return;const s=new URL(t.href);if(s.hostname.includes(this.#n.storageDomain)){if(this.#n.stripUtmsFromInternalLinks){if(!s.search.includes("utm_"))return;this.#a.utm.forEach((e=>{s.searchParams.delete(`utm_${e}`)}))}}else{if(!this.#n.decorateHostnames.some((e=>s.hostname.includes(e)||s.hostname===e)))return;const e=this.#x(this.activeSession);for(const[t,n]of Object.entries(e))t.startsWith("_")||s.searchParams.set(t,n)}t.href=s.href}),!0);const e=((e,t)=>{let s,n=!0;return function(...i){if(n)return n=!1,void e(...i);clearTimeout(s),s=setTimeout((()=>{clearTimeout(s),e(...i)}),t)}})((e=>{const t=e.target.closest("form");t&&this.fill(t)}),1500);["mousedown","touchstart"].forEach((t=>{document.addEventListener(t,(t=>{e(t),this.#N()}))}));const t=this.#E(this.#e);document.addEventListener(`${t}:consent.change`,(e=>{const{type:t,status:s}=e.detail;this.#F(t,s)}))}#R(e){const t=this.#o[e];if(!Object.keys(t).length)return;const s=this.#r[e];for(const e of s)if(!t.hasOwnProperty(e))return!1;return!0}#C({applyFilters:e=!1}={}){let t={};if(!this.#n.fieldMap.cookies)return t;for(const[s,n]of Object.entries(this.#n.fieldMap.cookies)){let n=this.#z(s);n=this.#T(n,{maybeJson:!0}),n&&(e&&(n=this.#M(this.#n.filters[s],n)),t[s]=n)}return t}#L({applyFilters:e=!1}={}){let t={};for(const[s,n]of Object.entries(this.#n.fieldMap.globals))try{let n=this.#U(s);if(n=this.#T(n,{maxLength:1024}),!n)continue;e&&(n=this.#M(this.#n.filters[s],n)),t[s]=n}catch(e){console.error(`${this.#e}.js: Error resolving global "${s}"`,e.message)}return t}#v(e){return{granted:!0,denied:!1,null:!0,null:!0}[this.#n.consent[e]]}#F(e,t){this.#n.consent[e]=t?t.toLowerCase():null}#j(e){return JSON.parse(JSON.stringify(e))}#d(e,t){for(const s in t)t.hasOwnProperty(s)&&(Array.isArray(t[s])?e[s]=t[s].slice():"object"==typeof t[s]&&null!==t[s]?(e[s]||(e[s]={}),this.#d(e[s],t[s])):e[s]=t[s]);return e}#x(e,t=""){return Object.keys(e).reduce(((s,n)=>{const i=t.length?`${t}_`:"";return"object"!=typeof e[n]||null===e[n]||Array.isArray(e[n])?s[`${i}${n}`]=e[n]:Object.assign(s,this.#x(e[n],`${i}${n}`)),s}),{})}#A(e=[],t){return e.map((e=>{const s={class:"input."+t,parentClass:"."+t+" input",dataAttribute:"input["+this.#n.fieldDataAttribute+'="'+t+'"]',name:'input[name="'+t+'"]'};return s[e]||s.name})).join(",")}#z(e){const t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]+)"));return t?t[2].trim():null}#J({value:e=0,units:t="minutes"}={}){const s={minutes:60,hours:3600,days:86400,weeks:604800,months:2592e3,years:31536e3}[t.toLowerCase()];return s?parseInt(e)*s:0}#$(){const e=this.#l.last;e&&e._exp<Math.ceil(Date.now()/1e3)&&this.#G("last");const t=this.#n.namespace;let s={utm:{source:"(direct)",medium:"(none)"}};s[t]={};const n=this.#R("utm"),i=this.#R(t);if(n||i)n&&Object.assign(s.utm,this.#o.utm),i&&Object.assign(s[t],this.#o[t]);else{const e=this.activeSession,n=(e,t)=>!(!e||!this.#r[t])&&this.#r[t].every((s=>e[t]?.[s]&&(!["utm"].includes(t)||"source"===s&&"(direct)"!==e[t][s]||"medium"===s&&"(none)"!==e[t][s]))),i=n(e,"utm"),o=n(e,t);i||o?s=e:Object.assign(s.utm,this.#H())}this.#l?.first?s=this.#l.last&&"(direct)"===s.utm.source?this.#l.last:s:(this.#l.first=s,this.#W("first",s),s={_ref:"first"}),this.#l.last=s,this.#W("last",s)}#I(){console.warn(`${this.#e}.js: config.enableSpaSupport = true monkeypatches the the history.pushState() method.`);let e=history.pushState;history.pushState=function(t){return"function"==typeof history.onpushstate&&history.onpushstate({state:t}),e.apply(history,arguments)}}#H(){let e={};if(!this.#c||this.#c.hostname.indexOf(this.#n.storageDomain)>-1)return e;e={source:this.#c.hostname,medium:"referral"};for(const[t,s]of Object.entries(this.#n.parseRules)){for(const[n,i]of Object.entries(s))if(this.#c.hostname.match(i)){e.source=n,e.medium=`${t}`;break}if(Object.keys(s).indexOf(e.medium)>-1)break}return e}#p(){if(this.#n.storageDomain)return;const e=this.#u.hostname;if("localhost"===e)return"";const t=e.split(".");this.#n.storageDomain=t.length<=2?e:t.slice(-2).join(".")}#U(e){return e.split(".").reduce(((e,t)=>e?e[t]:null),window)}#K(e,t=10){let s,n=0;do{s=e;try{e=decodeURIComponent(e),n++}catch(e){break}}while(s!==e&&n<t);return e}#T(e,{maybeJson:t=!1,maxLength:s=255}={}){if("string"!=typeof e||!e)return"";let n=String(e).trim();n=this.#K(n);if(n=(new DOMParser).parseFromString(n,"text/html").body.textContent||"",t&&n.startsWith("{")&&n.endsWith("}"))try{return n=JSON.stringify(JSON.parse(n)),n}catch(e){}return n=n.replace(/['"<>]/g,""),n=n.replace(/[^a-zA-Z0-9_\-%.?@#&+~$!:;,=/|\[\]\(\) ]/g,""),(n.startsWith("http")||n.startsWith("/"))&&n.includes("?")&&(n=encodeURI(n)),n=n.slice(0,s),n}#_(){let e={};const t=Math.ceil(Date.now()/1e3);for(const[s,n]of Object.entries(this.#h))e[s]=this.#O(s),"cookie"!==this.#n.storageMethod&&e[s]?._exp<t&&(this.#G(s),e[s]=null);return e}#g(){const e=`_${this.#n.storageNamespace}_anonymous_id`;this.#s=this.#z(e),this.#s||(this.#s=`CC.1.${Date.now()}.${Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}`),"cookie"===this.#n.storageMethod?document.cookie=`${e}=${this.#s}; max-age=${this.#J({value:400,units:"days"})}; path=/; domain=${this.#n.storageDomain}; secure`:localStorage.setItem(e,this.#s)}#f(){const e=this.#n.fieldMap;for(const[t,s]of Object.entries(e))if(["first","last"].includes(t))for(const[e,n]of Object.entries(s)){let s={};this.#a[e].forEach((n=>{let i="$ns"===e?this.#n.namespace:e;s[n]=`${i}_${n}`,"first"==t&&(s[n]+="_1st")}));let i=this.#d(s,n);"$ns"===e?(this.#n.fieldMap[t][this.#n.namespace]=i,delete this.#n.fieldMap[t][e]):this.#n.fieldMap[t][e]=i}}#w(){let e=this.#a.$ns,t=this.#r.$ns;this.#a[this.#n.namespace]=e,this.#r[this.#n.namespace]=t,delete this.#a.$ns,delete this.#r.$ns}#b(e=[]){const t=this.#u.searchParams;let s={};e=e.length>0?e:[this.#n.namespace],this.#u.search.includes("hsa_")&&e.push("hsa");for(const t of e)s[t]={};const n="stray";if(s[n]={},t){for(const[i,o]of t.entries()){let t=!1;for(const n of e)if(i.startsWith(n+"_")){const e=i.slice(n.length+1);this.#a[n].includes(e)&&(s[n][e]=this.#T(o),t=!0);break}t||(s[n][i]=this.#T(o))}if(s.hasOwnProperty("hsa")){const e={net:"$ns.platform",src:"$ns.network",cam:"$ns.campaign",grp:"$ns.group",ad:"$ns.ad",tgt:"$ns.target",mt:"$ns.matchtype",kw:"utm.term"};for(const[t,n]of Object.entries(s.hsa)){if(!n||!e.hasOwnProperty(t))continue;let[i,o]=e[t].split(".");i=i.replace("$ns",this.#n.namespace),s[i].hasOwnProperty(o)||(s[i][o]="platform"==o?{adwords:"google",facebook:"meta"}[n]??n:n)}delete s.hsa}this.#o=s}else this.#o=s}#y(e=!1){let t;t=e?null:document.referrer?new URL(document.referrer):null,this.#c=t}#G(e){const t=this.#q(e);this.#l[e]=null,"cookie"===this.#n.storageMethod?document.cookie=`${t}=; max-age=0; path=/; domain=${this.#n.storageDomain}`:localStorage.removeItem(t)}#O(e){const t=this.#q(e);let s="cookie"===this.#n.storageMethod?this.#z(t):localStorage.getItem(t);return s?(s.startsWith("$:")&&(s=atob(s.split(":")[1])),s=JSON.parse(s),"null"===s&&(s=null),s):null}#N(){let e=this.#O("last");e&&this.#W("last",e)}#W(e,t){const s=Math.ceil(Date.now()/1e3);t._set||(t._set=s);const[n,i]=this.#h[e].expires,o=this.#J({value:n,units:i});t._exp=o+s,this.#l[e]=t,t=JSON.stringify(t),this.#n.storeAsBase64&&(t=`$:${btoa(t)}`);const a=this.#q(e);"cookie"===this.#n.storageMethod?document.cookie=`${a}=${t}; max-age=${o}; path=/; domain=${this.#n.storageDomain}; secure`:localStorage.setItem(a,t)}#m(){let e=this.#n.namespace.toLowerCase().trim();if("lvl"==e)return;[/[a-z]{2,4}/.test(e),"utm"!==e].includes(!1)&&(console.warn('Invalid namespace: Defaulting to "lvl".'),this.#n.namespace="lvl")}#q(e){return`_${this.#n.storageNamespace}_${e}`}#E(e){return e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase()}}return t=t.default})()));